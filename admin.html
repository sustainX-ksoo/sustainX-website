<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sustainX - ë¬¸ì˜ ê´€ë¦¬</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="./dist/output.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js?v=1.0"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js?v=1.0"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js?v=1.0"></script>
    <script src="firebase-config.js?v=1.0"></script>
    <style>
        /* ë°°ê²½ ì´ë¯¸ì§€ fallback CSS */
        .admin-bg {
            background-image: url('images/admin/admin-bg.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        
        /* ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ë°°ê²½ */
        .admin-bg.bg-fallback {
            background: linear-gradient(135deg, #0A1628 0%, #1B4D3E 50%, #2C3E50 100%);
        }
        
        /* ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ ì‹œ ì• ë‹ˆë©”ì´ì…˜ */
        .admin-bg.bg-loaded {
            animation: fadeInBackground 0.5s ease-in-out;
        }
        
        @keyframes fadeInBackground {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }
        
        /* ë¡œë”© ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .admin-bg:not(.bg-loaded):not(.bg-fallback) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-cover bg-center bg-fixed bg-no-repeat min-h-screen relative admin-bg" style="background-image: url('images/admin/admin-bg.jpg');">
    <!-- ë°°ê²½ ì˜¤ë²„ë ˆì´ -->
    <div class="fixed inset-0 bg-white/40 backdrop-blur-[1px] z-0"></div>
    
    <div class="min-h-screen relative z-10">
        <!-- í—¤ë” -->
        <header class="bg-white/80 backdrop-blur-md shadow-lg border-b border-white/20">
            <div class="container mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold text-brand-blue">sustainX</h1>
                        <span class="text-brand-blue/60">|</span>
                        <span class="text-lg text-brand-blue/80">ë¬¸ì˜ ê´€ë¦¬</span>
                    </div>
                    <div class="flex gap-4">
                        <button id="refresh-btn" class="bg-brand-blue text-white px-4 py-2 rounded-lg hover:bg-brand-green transition-colors">
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button id="export-btn" class="bg-brand-green text-white px-4 py-2 rounded-lg hover:bg-brand-blue transition-colors">
                            ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                        </button>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                        <a href="index.html" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            í™ˆí˜ì´ì§€ë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white/60 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/30 hover:bg-white/70 transition-all duration-300">
                    <h3 class="text-sm font-medium text-brand-blue/70 mb-2">ì „ì²´ ë¬¸ì˜</h3>
                    <p id="total-count" class="text-3xl font-bold text-brand-blue">0</p>
                </div>
                <div class="bg-white/60 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/30 hover:bg-white/70 transition-all duration-300">
                    <h3 class="text-sm font-medium text-green-700/70 mb-2">ì‹ ê·œ ë¬¸ì˜</h3>
                    <p id="new-count" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white/60 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/30 hover:bg-white/70 transition-all duration-300">
                    <h3 class="text-sm font-medium text-yellow-700/70 mb-2">ì²˜ë¦¬ ì¤‘</h3>
                    <p id="processing-count" class="text-3xl font-bold text-yellow-600">0</p>
                </div>
                <div class="bg-white/60 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/30 hover:bg-white/70 transition-all duration-300">
                    <h3 class="text-sm font-medium text-gray-600/70 mb-2">ì™„ë£Œ</h3>
                    <p id="completed-count" class="text-3xl font-bold text-gray-600">0</p>
                </div>
            </div>

            <!-- í•„í„° -->
            <div class="bg-white/60 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/30 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-brand-blue/80 mb-1">ìƒíƒœ</label>
                        <select id="status-filter" class="border border-brand-blue/20 rounded-lg px-3 py-2 bg-white/80 focus:ring-2 focus:ring-brand-blue/30 focus:border-brand-blue transition-all">
                            <option value="">ì „ì²´</option>
                            <option value="new">ì‹ ê·œ</option>
                            <option value="processing">ì²˜ë¦¬ì¤‘</option>
                            <option value="completed">ì™„ë£Œ</option>
                        </select>
                    </div>
                    <div>
                        <label for="industry-filter" class="block text-sm font-medium text-brand-blue/80 mb-1">ì—…ì¢…</label>
                        <select id="industry-filter" class="border border-brand-blue/20 rounded-lg px-3 py-2 bg-white/80 focus:ring-2 focus:ring-brand-blue/30 focus:border-brand-blue transition-all">
                            <option value="">ì „ì²´</option>
                            <option value="automotive">ìë™ì°¨/ë¶€í’ˆ</option>
                            <option value="electronics">ì „ì/ì „ê¸°</option>
                            <option value="manufacturing">ì œì¡°ì—…</option>
                            <option value="chemical">í™”í•™/ì†Œì¬</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div>
                        <label for="date-filter" class="block text-sm font-medium text-brand-blue/80 mb-1">ê¸°ê°„</label>
                        <select id="date-filter" class="border border-brand-blue/20 rounded-lg px-3 py-2 bg-white/80 focus:ring-2 focus:ring-brand-blue/30 focus:border-brand-blue transition-all">
                            <option value="">ì „ì²´</option>
                            <option value="today">ì˜¤ëŠ˜</option>
                            <option value="week">ì´ë²ˆ ì£¼</option>
                            <option value="month">ì´ë²ˆ ë‹¬</option>
                        </select>
                    </div>
                    <div class="flex-1"></div>
                    <button id="clear-filters" class="bg-brand-blue/80 text-white px-4 py-2 rounded-lg hover:bg-brand-blue transition-colors shadow-md">
                        í•„í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- ë¬¸ì˜ ëª©ë¡ -->
            <div class="bg-white/60 backdrop-blur-sm rounded-xl shadow-lg border border-white/30 overflow-hidden">
                <div class="px-6 py-4 border-b border-white/30 bg-gradient-to-r from-brand-blue/10 to-brand-green/10">
                    <h2 class="text-lg font-semibold text-brand-blue">ë¬¸ì˜ ëª©ë¡</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="inquiry-table">
                        <thead class="bg-gradient-to-r from-brand-blue/5 to-brand-green/5">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ì ‘ìˆ˜ì‹œê°„
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    íšŒì‚¬ëª…
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ë‹´ë‹¹ì
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ì§ì±…
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ì—°ë½ì²˜
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ì—…ì¢…
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ìƒë‹´ì‹œê¸°
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ìƒíƒœ
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-blue/70 uppercase tracking-wider">
                                    ì‘ì—…
                                </th>
                            </tr>
                        </thead>
                        <tbody id="inquiry-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- ë¬¸ì˜ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-state" class="p-12 text-center text-gray-500 hidden">
                    <p class="text-lg mb-2">ì•„ì§ ì ‘ìˆ˜ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm">í™ˆí˜ì´ì§€ì—ì„œ ë¬¸ì˜ë¥¼ ì ‘ìˆ˜í•´ë³´ì„¸ìš”.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- ë¬¸ì˜ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white/80 backdrop-blur-md max-w-2xl w-full max-h-[90vh] overflow-y-auto rounded-xl shadow-2xl border border-white/30">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-brand-blue">ë¬¸ì˜ ìƒì„¸</h3>
                    <button id="close-detail" class="text-brand-blue/60 hover:text-brand-blue text-2xl transition-colors">&times;</button>
                </div>
                
                <div id="detail-content" class="space-y-4">
                    <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="mt-6 pt-6 border-t border-white/30">
                    <h4 class="text-sm font-medium text-brand-blue/80 mb-3">ìƒíƒœ ë³€ê²½</h4>
                    <div class="flex gap-2">
                        <button class="status-btn bg-green-500/80 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm hover:bg-green-500 transition-all border border-white/20" data-status="new">
                            ì‹ ê·œ
                        </button>
                        <button class="status-btn bg-yellow-500/80 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm hover:bg-yellow-500 transition-all border border-white/20" data-status="processing">
                            ì²˜ë¦¬ì¤‘
                        </button>
                        <button class="status-btn bg-gray-500/80 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-500 transition-all border border-white/20" data-status="completed">
                            ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentInquiries = [];
        let currentInquiryId = null;
        
        // ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ì¸ì¦ ì²´í¬ (ë””ë²„ê¹… ê²°ê³¼ ë°˜ì˜)
        function checkAdminAuth() {
            return new Promise((resolve) => {
                console.log('=== ê´€ë¦¬ì ì¸ì¦ ì²´í¬ ì‹œì‘ ===');
                
                // ì¦‰ì‹œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
                if (auth && auth.currentUser) {
                    console.log('âœ… ì¸ì¦ëœ ì‚¬ìš©ì ë°œê²¬:', auth.currentUser.email);
                    resolve(true);
                    return;
                }
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í™•ì¸
                const sessionAuth = sessionStorage.getItem('sustainx_admin_logged_in');
                const sessionEmail = sessionStorage.getItem('sustainx_admin_email');
                
                if (sessionAuth === 'true' && sessionEmail) {
                    console.log('âœ… ìœ íš¨í•œ ì„¸ì…˜ ë°œê²¬:', sessionEmail);
                    resolve(true);
                    return;
                }
                
                // Auth ìƒíƒœ ë³€í™” ë¦¬ìŠ¤ë„ˆ (1íšŒë§Œ)
                console.log('Auth ìƒíƒœ ë³€í™” ëŒ€ê¸°...');
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    console.log('Auth ìƒíƒœ ë³€í™”:', user ? user.email : 'ë¡œê·¸ì•„ì›ƒ');
                    unsubscribe();
                    
                    if (user) {
                        console.log('âœ… ì¸ì¦ ì„±ê³µ:', user.email);
                        resolve(true);
                    } else {
                        console.log('âŒ ì¸ì¦ ì‹¤íŒ¨');
                        resolve(false);
                    }
                });
                
                // 2ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => {
                    console.log('â° íƒ€ì„ì•„ì›ƒ - ì¸ì¦ ì‹¤íŒ¨');
                    unsubscribe();
                    resolve(false);
                }, 2000);
            });
        }
        
        // í™ˆí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        function redirectToHome() {
            console.log('=== í™ˆí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ===');
            console.log('ì¸ì¦ ìƒíƒœ:', {
                currentUser: auth?.currentUser,
                sessionAuth: sessionStorage.getItem('sustainx_admin_logged_in'),
                sessionEmail: sessionStorage.getItem('sustainx_admin_email')
            });
            alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'index.html';
        }
        
        // Firebase Auth ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „)
        async function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
                    sessionStorage.removeItem('sustainx_admin_logged_in');
                    sessionStorage.removeItem('sustainx_admin_email');
                    sessionStorage.removeItem('sustainx_admin_login_time');
                    console.log('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬ ì™„ë£Œ');
                    
                    // Firebase Auth ë¡œê·¸ì•„ì›ƒ
                    await auth.signOut();
                    console.log('Firebase Auth ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
                    
                    // í™ˆí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error.message);
                    alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ì´ˆê¸°í™” (ë” ê°„ë‹¨í•˜ê³  í™•ì‹¤í•˜ê²Œ)
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                // Firebaseê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° (10ì´ˆ ëŒ€ê¸°)
                let attempts = 0;
                while ((!window.auth || !window.db) && attempts < 100) {
                    console.log(`Firebase ë¡œë”© ëŒ€ê¸° ì¤‘... (${attempts + 1}/100)`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.auth || !window.db) {
                    throw new Error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨');
                }
                
                console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ì¸ì¦ ì²´í¬
                console.log('ğŸ” ì¸ì¦ ì²´í¬ ì‹œì‘');
                const isAuthenticated = await checkAdminAuth();
                
                console.log('ğŸ“Š ì¸ì¦ ê²°ê³¼:', isAuthenticated);
                
                if (!isAuthenticated) {
                    console.log('âŒ ì¸ì¦ ì‹¤íŒ¨ - ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    redirectToHome();
                    return;
                }
                
                console.log('âœ… ì¸ì¦ ì„±ê³µ - ë°ì´í„° ë¡œë“œ');
                
                // ë°ì´í„° ë¡œë“œ ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
                await loadInquiries();
                bindEvents();
                
                console.log('ğŸ‰ ì´ˆê¸°í™” ì™„ë£Œ!');
                
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`);
                redirectToHome();
            }
        });

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        function bindEvents() {
            document.getElementById('refresh-btn').addEventListener('click', loadInquiries);
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('status-filter').addEventListener('change', filterInquiries);
            document.getElementById('industry-filter').addEventListener('change', filterInquiries);
            document.getElementById('date-filter').addEventListener('change', filterInquiries);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            document.getElementById('close-detail').addEventListener('click', closeDetailModal);
            
            // ìƒíƒœ ë³€ê²½ ë²„íŠ¼
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const status = e.target.dataset.status;
                    updateInquiryStatus(currentInquiryId, status);
                });
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.getElementById('detail-modal').addEventListener('click', (e) => {
                if (e.target.id === 'detail-modal') {
                    closeDetailModal();
                }
            });
        }

        // Firestoreì—ì„œ ë¬¸ì˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadInquiries() {
            try {
                const snapshot = await db.collection('inquiries').orderBy('createdAt', 'desc').get();
                currentInquiries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStatistics();
                renderInquiries(currentInquiries);
            } catch (error) {
                console.error('ë¬¸ì˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const total = currentInquiries.length;
            const newCount = currentInquiries.filter(i => i.status === 'new').length;
            const processingCount = currentInquiries.filter(i => i.status === 'processing').length;
            const completedCount = currentInquiries.filter(i => i.status === 'completed').length;

            document.getElementById('total-count').textContent = total;
            document.getElementById('new-count').textContent = newCount;
            document.getElementById('processing-count').textContent = processingCount;
            document.getElementById('completed-count').textContent = completedCount;
        }

        // ë¬¸ì˜ ëª©ë¡ ë Œë”ë§
        function renderInquiries(inquiries) {
            const tableBody = document.getElementById('inquiry-table-body');
            const emptyState = document.getElementById('empty-state');

            if (inquiries.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableBody.innerHTML = inquiries.map(inquiry => `
                <tr class="hover:bg-gray-50 cursor-pointer inquiry-row" data-id="${inquiry.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatDateTime(inquiry.createdAt)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${inquiry.company}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${inquiry.name}</div>
                        <div class="text-sm text-gray-500">${inquiry.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${inquiry.position || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${inquiry.phone || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${getIndustryText(inquiry.industry)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${getConsultationTimeText(inquiry.consultationTime)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(inquiry.status)}">
                            ${getStatusText(inquiry.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-3 detail-btn" data-id="${inquiry.id}">
                            ìƒì„¸ë³´ê¸°
                        </button>
                        <button class="text-green-600 hover:text-green-900 status-update-btn" data-id="${inquiry.id}" data-status="${getNextStatus(inquiry.status)}">
                            ${getNextStatusText(inquiry.status)}
                        </button>
                    </td>
                </tr>
            `).join('');

            // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            document.querySelectorAll('.detail-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const inquiryId = btn.dataset.id;
                    showInquiryDetail(inquiryId);
                });
            });

            // ìƒíƒœ ì—…ë°ì´íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.querySelectorAll('.status-update-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const inquiryId = btn.dataset.id;
                    const nextStatus = btn.dataset.status;
                    if (nextStatus) {
                        updateInquiryStatus(inquiryId, nextStatus);
                    }
                });
            });

            // í–‰ í´ë¦­ ì´ë²¤íŠ¸ (ìƒì„¸ë³´ê¸°)
            document.querySelectorAll('.inquiry-row').forEach(row => {
                row.addEventListener('click', () => {
                    const inquiryId = row.dataset.id;
                    showInquiryDetail(inquiryId);
                });
            });
        }

        // ë¬¸ì˜ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
        function showInquiryDetail(inquiryId) {
            const inquiry = currentInquiries.find(i => i.id === inquiryId);
            if (!inquiry) return;

            currentInquiryId = inquiryId;
            const detailContent = document.getElementById('detail-content');
            
            detailContent.innerHTML = `
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">íšŒì‚¬ëª…</label>
                        <p class="mt-1 text-sm text-gray-900">${inquiry.company}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ë‹´ë‹¹ìëª…</label>
                        <p class="mt-1 text-sm text-gray-900">${inquiry.name}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <p class="mt-1 text-sm text-gray-900">${inquiry.email}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
                        <p class="mt-1 text-sm text-gray-900">${inquiry.phone || '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì§ì±…</label>
                        <p class="mt-1 text-sm text-gray-900">${inquiry.position || '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì—…ì¢…</label>
                        <p class="mt-1 text-sm text-gray-900">${getIndustryText(inquiry.industry)}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">í¬ë§ ìƒë‹´ ì‹œê¸°</label>
                        <p class="mt-1 text-sm text-gray-900">${getConsultationTimeText(inquiry.consultationTime)}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì ‘ìˆ˜ ì‹œê°„</label>
                        <p class="mt-1 text-sm text-gray-900">${formatDate(inquiry.createdAt)}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">ESG ê³ ë¯¼ì‚¬í•­</label>
                    <p class="mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded">${inquiry.concern}</p>
                </div>
            `;

            document.getElementById('detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // ë¬¸ì˜ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentInquiryId = null;
        }

        // ë¬¸ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (Firestore) - ë””ë²„ê¹… ê°•í™”
        async function updateInquiryStatus(id, status) {
            console.log('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„:', { id, status });
            
            try {
                // í˜„ì¬ ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì');
                }
                console.log('ì¸ì¦ëœ ì‚¬ìš©ì:', currentUser.email);
                
                // Firestore ì—…ë°ì´íŠ¸ ì‹œë„
                const updateData = {
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                };
                console.log('ì—…ë°ì´íŠ¸í•  ë°ì´í„°:', updateData);
                
                await db.collection('inquiries').doc(id).update(updateData);
                console.log('Firestore ì—…ë°ì´íŠ¸ ì„±ê³µ');
                
                // ë°ì´í„° ì¬ë¡œë“œ
                await loadInquiries();
                showToast('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeDetailModal();
                
            } catch (error) {
                console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ìƒì„¸ ì˜¤ë¥˜:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // ì‚¬ìš©ìì—ê²Œ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                let errorMessage = 'ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'permission-denied') {
                    errorMessage = 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ë¡œê·¸ì¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.code === 'not-found') {
                    errorMessage = 'ë¬¸ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
                
                showToast(errorMessage);
                alert(`ì˜¤ë¥˜ ìƒì„¸: ${error.message}`);
            }
        }

        // í•„í„°ë§
        function filterInquiries() {
            const statusFilter = document.getElementById('status-filter').value;
            const industryFilter = document.getElementById('industry-filter').value;
            const dateFilter = document.getElementById('date-filter').value;

            let filtered = [...currentInquiries];

            if (statusFilter) {
                filtered = filtered.filter(i => i.status === statusFilter);
            }

            if (industryFilter) {
                filtered = filtered.filter(i => i.industry === industryFilter);
            }

            if (dateFilter) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

                filtered = filtered.filter(i => {
                    const inquiryDate = new Date(i.timestamp);
                    
                    switch(dateFilter) {
                        case 'today':
                            return inquiryDate >= today;
                        case 'week':
                            return inquiryDate >= weekStart;
                        case 'month':
                            return inquiryDate >= monthStart;
                        default:
                            return true;
                    }
                });
            }

            renderInquiries(filtered);
        }

        // í•„í„° ì´ˆê¸°í™”
        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('industry-filter').value = '';
            document.getElementById('date-filter').value = '';
            renderInquiries(currentInquiries);
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ì—‘ì…€ í˜•íƒœ)
        function exportData() {
            if (currentInquiries.length === 0) {
                showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì—‘ì…€ì— í‘œì‹œí•  ë°ì´í„° êµ¬ì„±
            const excelData = currentInquiries.map((inquiry, index) => {
                return {
                    'ìˆœë²ˆ': index + 1,
                    'ì ‘ìˆ˜ì‹œê°„': formatDateForExcel(inquiry.createdAt),
                    'íšŒì‚¬ëª…': inquiry.company || '',
                    'ë‹´ë‹¹ìëª…': inquiry.name || '',
                    'ì§ì±…': inquiry.position || '',
                    'ì´ë©”ì¼': inquiry.email || '',
                    'ì—°ë½ì²˜': inquiry.phone || '',
                    'ì—…ì¢…': getIndustryText(inquiry.industry),
                    'ESG ê³ ë¯¼ì‚¬í•­': inquiry.concern || '',
                    'í¬ë§ ìƒë‹´ì‹œê¸°': getConsultationTimeText(inquiry.consultationTime),
                    'ìƒíƒœ': getStatusText(inquiry.status),
                    'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸': inquiry.updatedAt ? formatDateForExcel(inquiry.updatedAt) : '-'
                };
            });

            // ì›Œí¬ë¶ ìƒì„±
            const workbook = XLSX.utils.book_new();
            
            // ì›Œí¬ì‹œíŠ¸ ìƒì„±
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            
            // ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const columnWidths = [];
            
            // ê° ì—´ì˜ ìµœëŒ€ ë„ˆë¹„ ê³„ì‚°
            for (let col = range.s.c; col <= range.e.c; col++) {
                let maxWidth = 10; // ìµœì†Œ ë„ˆë¹„
                
                for (let row = range.s.r; row <= range.e.r; row++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = worksheet[cellAddress];
                    
                    if (cell && cell.v) {
                        const cellLength = cell.v.toString().length;
                        maxWidth = Math.max(maxWidth, cellLength);
                    }
                }
                
                // í•œê¸€ ê³ ë ¤í•˜ì—¬ ë„ˆë¹„ ì¡°ì •
                columnWidths.push({ wch: Math.min(maxWidth * 1.2, 50) });
            }
            
            worksheet['!cols'] = columnWidths;
            
            // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ë¬¸ì˜ ëª©ë¡');
            
            // íŒŒì¼ëª… ìƒì„±
            const now = new Date();
            const dateStr = now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0') + 
                           '_' + 
                           String(now.getHours()).padStart(2, '0') + 
                           String(now.getMinutes()).padStart(2, '0');
            
            const fileName = `sustainX_ë¬¸ì˜ëª©ë¡_${dateStr}.xlsx`;
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(workbook, fileName);
            
            showToast(`ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`);
        }
        
        // ì—‘ì…€ìš© ë‚ ì§œ í¬ë§§
        function formatDateForExcel(timestamp) {
            return new Date(timestamp).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'bg-green-100 text-green-800';
                case 'processing': return 'bg-yellow-100 text-yellow-800';
                case 'completed': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'new': return 'ì‹ ê·œ';
                case 'processing': return 'ì²˜ë¦¬ì¤‘';
                case 'completed': return 'ì™„ë£Œ';
                default: return 'ë¯¸ë¶„ë¥˜';
            }
        }

        function getIndustryText(industry) {
            switch(industry) {
                case 'automotive': return 'ìë™ì°¨/ë¶€í’ˆ';
                case 'electronics': return 'ì „ì/ì „ê¸°';
                case 'manufacturing': return 'ì œì¡°ì—…';
                case 'chemical': return 'í™”í•™/ì†Œì¬';
                case 'other': return 'ê¸°íƒ€';
                default: return '-';
            }
        }

        function getConsultationTimeText(time) {
            switch(time) {
                case 'immediately': return 'ìµœëŒ€í•œ ë¹ ë¥¸ ì‹œì¼ ë‚´';
                case 'next-week': return 'ë‹¤ìŒ ì£¼ ë‚´';
                case 'this-month': return 'ì´ë²ˆ ë‹¬ ë‚´';
                case 'flexible': return 'ìœ ì—°í•˜ê²Œ ì¡°ì • ê°€ëŠ¥';
                default: return '-';
            }
        }

        function formatDate(timestamp) {
            try {
                let date;
                
                // Firebase Timestamp ê°ì²´ ì²˜ë¦¬
                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else if (timestamp && timestamp.seconds) {
                    date = new Date(timestamp.seconds * 1000);
                } else if (timestamp) {
                    date = new Date(timestamp);
                } else {
                    return '-';
                }
                
                return date.toLocaleString('ko-KR');
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§·íŒ… ì˜¤ë¥˜:', error, 'ì›ë³¸ ë°ì´í„°:', timestamp);
                return '-';
            }
        }
        
        // ë‚ ì§œì‹œê°„ í¬ë§§íŒ… (í…Œì´ë¸”ìš© - ë” ê°„ê²°í•˜ê²Œ)
        function formatDateTime(timestamp) {
            try {
                let date;
                
                // Firebase Timestamp ê°ì²´ ì²˜ë¦¬
                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else if (timestamp && timestamp.seconds) {
                    // Firebase Timestamp ê°ì²´ì˜ ê²½ìš°
                    date = new Date(timestamp.seconds * 1000);
                } else if (timestamp) {
                    // ì¼ë°˜ timestamp ë˜ëŠ” Date ê°ì²´
                    date = new Date(timestamp);
                } else {
                    return '-';
                }
                
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${month}/${day} ${hours}:${minutes}`;
                
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§·íŒ… ì˜¤ë¥˜:', error, 'ì›ë³¸ ë°ì´í„°:', timestamp);
                return '-';
            }
        }
        
        // ë‹¤ìŒ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
        function getNextStatus(currentStatus) {
            switch(currentStatus) {
                case 'new': return 'processing';
                case 'processing': return 'completed';
                case 'completed': return null;
                default: return 'processing';
            }
        }
        
        // ë‹¤ìŒ ìƒíƒœ í…ìŠ¤íŠ¸
        function getNextStatusText(currentStatus) {
            switch(currentStatus) {
                case 'new': return 'ì²˜ë¦¬ì‹œì‘';
                case 'processing': return 'ì™„ë£Œì²˜ë¦¬';
                case 'completed': return '-';
                default: return 'ì²˜ë¦¬ì‹œì‘';
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg z-50 transform transition-transform duration-300 translate-x-full';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ë””ë²„ê¹…ìš© í•¨ìˆ˜ - ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
        window.sustainXAdmin = {
            // ì¸ì¦ ìƒíƒœ í™•ì¸
            checkAuth: () => {
                console.log('=== ğŸ” ì¸ì¦ ìƒíƒœ ë””ë²„ê¹… ===');
                console.log('Firebase Auth:', {
                    available: !!auth,
                    currentUser: auth?.currentUser,
                    email: auth?.currentUser?.email
                });
                console.log('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€:', {
                    logged_in: sessionStorage.getItem('sustainx_admin_logged_in'),
                    email: sessionStorage.getItem('sustainx_admin_email')
                });
                return { firebase: auth?.currentUser, session: sessionStorage.getItem('sustainx_admin_logged_in') };
            },
            
            // ê°•ì œ ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸ìš©)
            forceAuth: () => {
                console.log('ğŸ”“ ê°•ì œ ì¸ì¦ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)');
                sessionStorage.setItem('sustainx_admin_logged_in', 'true');
                sessionStorage.setItem('sustainx_admin_email', 'test@admin.com');
                console.log('ì„¸ì…˜ ì„¤ì • ì™„ë£Œ. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
            },
            
            // ì¸ì¦ ì´ˆê¸°í™”
            clearAuth: () => {
                console.log('ğŸ—‘ï¸ ì¸ì¦ ì •ë³´ ì´ˆê¸°í™”');
                sessionStorage.removeItem('sustainx_admin_logged_in');
                sessionStorage.removeItem('sustainx_admin_email');
                if (auth?.currentUser) {
                    auth.signOut();
                }
            },
            
            // ìˆ˜ë™ ì¸ì¦ ì²´í¬
            testAuth: async () => {
                console.log('ğŸ§ª ìˆ˜ë™ ì¸ì¦ í…ŒìŠ¤íŠ¸ ì‹œì‘');
                const result = await checkAdminAuth();
                console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
                return result;
            },
            
            // í˜ì´ì§€ ë¦¬ë¡œë“œ
            reload: () => {
                window.location.reload();
            }
        };
        
        console.log('ğŸ› ï¸ ë””ë²„ê¹… ë„êµ¬ê°€ sustainXAdmin ê°ì²´ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('ì‚¬ìš©ë²•: sustainXAdmin.checkAuth(), sustainXAdmin.testAuth() ë“±');
        
        // ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì²´í¬ ë° ë””ë²„ê¹…
        function checkBackgroundImage() {
            const body = document.body;
            const computedStyle = window.getComputedStyle(body);
            const backgroundImage = computedStyle.backgroundImage;
            
            console.log('=== ë°°ê²½ ì´ë¯¸ì§€ ì²´í¬ ===');
            console.log('ë°°ê²½ ì´ë¯¸ì§€ CSS:', backgroundImage);
            
            // ì´ë¯¸ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸
            const testImage = new Image();
            testImage.onload = () => {
                console.log('âœ… ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ');
                body.classList.add('bg-loaded');
            };
            testImage.onerror = () => {
                console.error('âŒ ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
                console.log('ê¸°ë³¸ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ ì‚¬ìš©');
                body.style.backgroundImage = 'none';
                body.classList.add('bg-fallback');
            };
            testImage.src = 'images/admin/admin-bg.jpg';
        }
        
        // sustainXAdminì— ë°°ê²½ ì²´í¬ í•¨ìˆ˜ ì¶”ê°€
        window.sustainXAdmin.checkBackground = checkBackgroundImage;
        
        // í˜ì´ì§€ ë¡œë“œ í›„ ë°°ê²½ ì´ë¯¸ì§€ ì²´í¬
        setTimeout(checkBackgroundImage, 1000);
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì¸ì¦ ìƒíƒœ ì²´í¬
        console.log('=== admin.html í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ===');
        console.log('í˜„ì¬ URL:', window.location.href);
        console.log('ì´ì „ í˜ì´ì§€:', document.referrer);
        
        // URLì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ì¸ì§€ í™•ì¸
        if (document.referrer.includes('index.html') || document.referrer.endsWith('/')) {
            console.log('í™ˆí˜ì´ì§€ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²ƒìœ¼ë¡œ ë³´ì„ (ë¡œê·¸ì¸ í›„)');
        }
    </script>
</body>
</html>